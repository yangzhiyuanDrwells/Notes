<font size = 4 face = "黑体">

&emsp;&emsp;<a href="#network_layer">网络层</a>

&emsp;&emsp;&emsp;&emsp;<a href="#IP">IP协议</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#segmentation_form">协议头格式</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#Network_segmentation">网段划分(重要)</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#private_public_IP_address">私有IP地址和公网IP地址</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#route">路由</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#route_table_build">路由表生成算法</a>

&emsp;&emsp;<a href="#data_link_layer">数据链路层</a>

&emsp;&emsp;&emsp;&emsp;<a href="#Ethernet">以太网</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#Ethernet_frame_form">以太网帧格式(链路层)</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#MAC">MAC地址</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#MTU">MTU</a>

&emsp;&emsp;&emsp;&emsp;<a href="#ARP">ARP协议</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#ARP_application">ARP协议的作用</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#ARP_work_flow">ARP协议的工作流程</a>

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a href="#ARP_message_form">ARP数据报的格式</a>

&emsp;&emsp;<a href="#protocols">重要协议</a>

&emsp;&emsp;&emsp;&emsp;<a href="#DNS">DNS</a>

<a id="network_layer"></a>

<br/><br/>

## 网络层
<a id="IP"></a>

<br/><br/>


### IP协议

- 主机: 配有IP地址, 但是不进行路由控制的设备; 

- 路由器: 即配有IP地址, 又能进行路由控制; 

- 节点: 主机和路由器的统称;


<a id="segmentation_form"></a>

<br/><br/>
#### 协议头格式

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210418134932878.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODA4NzAw,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210701170953168.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODA4NzAw,size_16,color_FFFFFF,t_70)


- 4位**版本号(version)**: 指定IP协议的版本，通信双方使用的 IP 协议版本必须一致。目前广泛使用的IP协议版本号为 4，即 IPv4。
- 4位**头部长度(header length)**: 占 4 位，可表示的最大十进制数值是 15。这个字段所表示数的单位是 32 位字长(1 个 32 位字长是 4 字节)。因此，当 IP 的首部长度为 1111 时(即十进制的 15)，首部长度就达到 60 字节。当 IP 分组的首部长度不是 4 字节的整数倍时，必须利用最后的填充字段加以填充。
- 8位**服务类型(Type Of Service)**: 也被称为服务类型，占 8 位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998 年 IETF 把这个字段改名为区分服务(Differentiated Services，DS)。只有在使用区分服务时，这个字段才起作用。**3位优先权字段(已经弃用), 4位TOS字段, 和1位保留字段**(必须置为0). 4位TOS分别表示: 最小延时, 最大吞吐量, 最高可靠性, 最小成本. 这四者相互冲突,只能选择一个. 对于ssh/telnet这样的应用程序, 最小延时比较重要; 对于ftp这样的程序, 最大吞吐量比较重要.
- 16位**总长度(total length)**: IP数据报整体占多少个字节，首部和数据之和，单位为字节。总长度字段为 16 位，因此数据报的最大长度为 2^16-1=65535 字节。
- 16位**标识(identification)**: 唯一的标识主机发送的报文，如果IP报文在数据链路层被分片了, 那么每一个片里面的这个id都是相同的。用来标识数据报，占 16 位。IP 协议在存储器中维持一个计数器。每产生一个数据报，计数器就加 1，并将此值赋给标识字段。当数据报的长度超过网络的 MTU，而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。具有相同的标识字段值的分片报文会被重组成原来的数据报。
- 3位**标志字段(flag)**: 占 3 位。第一位保留未使用(保留的意思是现在不用, 但是还没想好说不定以后要用到)，其值为 0。第二位称为 DF(0表示允许分片，1表示禁止分片，这时候如果报文长度超过MTU, IP模块就会丢弃报文)。第三位称为 MF(更多分片)，表示是否还有分片正在传输，设置为 0 时，表示没有更多分片需要发送，或数据报没有分片，类似于一个结束标记。
- **13位分片偏移(framegament offset): 是分片相对于原始IP报文开始处的偏移**. 其实就是在表示当前分片在原报文中处在哪个位置. 片偏移以 8 个字节为偏移单位，实际偏移的字节数是这个值 * 8 得到的. 因此,除了最后一个报文之外, 其他报文的长度必须是8的整数倍(否则报文就不连续了).
- 8位**生存时间(Time To Live, TTL)**: 数据报到达目的地的最大报文跳数. 一般是64. 每次经过一个路由, TTL-= 1, 一直减到0还没到达, 那么就丢弃了. 这个字段主要是用来防止出现路由循环：防止无法交付的数据报无限制地在网络中传输，从而消耗网络资源。
- 8位**协议**: 表示该数据报文所携带的数据所使用的协议类型，占 8 位。该字段可以方便目的主机的 IP 层知道按照什么协议来处理数据部分。不同的协议有专门不同的协议号。
- 16位**头部校验和(checksum)**: 使用CRC进行校验, 来校验数据报的首部否损坏，占 16 位。数据报每经过一个路由器，首部的字段都可能发生变化(如TTL)，所以需要重新校验。而数据部分不发生变化，所以不用重新生成校验值。
- 32位**源地址**和32位**目的地址**: 表示发送端和接收端的IP地址。
- 选项字段(不定长, 最多40字节): 该字段用于一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由(数据报必须经过指定的路由)、网际时间戳(经过每个路由器时的时间戳记录)和安全限制。
- **填充**
由于可选字段中的长度不是固定的，使用若干个 0 填充该字段，可以保证整个报头的长度是 32 位的整数倍。
- **数据部分**
表示传输层的数据，如保存 TCP、UDP、ICMP 或 IGMP 的数据。数据部分的长度不固定。

<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=10>

<a id="Network_segmentation"></a>

<br/><br/>


#### 网段划分(重要)

- IP地址分
- - 网络号: 保证相互连接的两个网段具有不同的标识;
- - 主机号: 同一网段内, 主机之间具有相同的网络号, 但是必须有不同的主机号;

一个子网中主机的网络号相同

如果在子网中新增一台主机, 则这台主机的网络号和这个子网的网络号一致, 但是主机号必须不能和子网中的其他主机重复.

> DHCP, 能够自动的给子网内新增主机节点分配IP地址, 避免了手动管理IP的不便.
>
> 一般的路由器都带有DHCP功能. 因此路由器也可以看做一个DHCP服务器



##### 五类IP 地址

![在这里插入图片描述](https://img-blog.csdnimg.cn/2021041813563293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODA4NzAw,size_16,color_FFFFFF,t_70)

> A类 0.0.0.0到127.255.255.255
>
> B类 128.0.0.0到191.255.255.255
>
> C类 192.0.0.0到223.255.255.255
>
> D类 224.0.0.0到239.255.255.255
>
> E类 240.0.0.0到247.255.255.255

##### CIDR^[Classless Interdomain Routing:无类别域间路由,是一个用于给用户分配IP地址以及在互联网上有效地路由IP数据包的对IP地址进行归类的方法]

引入一个额外的子网掩码^[子网掩码也是一个32位的正整数. 通常用一串 "0" 来结尾](subnet mask)来区分网络号和主机号

将IP地址和子网掩码进行 "按位与" 操作, 得到的结果就是网络号,这样就可以区分是哪一类IP地址了

> 子网掩码除了用点分四个8位表示之外，还可以之间在IP地址后面加上/位数表示


##### 特殊的IP地址


1. 将IP地址中的主机地址全部为0, 就是网络号, 代表这个局域网;

2. 将IP地址中的主机地址全部设为1, 就成为了广播地址, 用于给同一个链路中相互连接的所有主机发送数据包;

3. 127.*的IP地址用于本机环回(loop back)测试,通常是127.0.0.1

##### IPv4的IP地址紧缺

IP地址(IPv4)是一个4字节32位的正整数. 那么一共只有 2的32次方 个IP地址, 大概是43亿左右.

1. 动态分配IP地址: 只给接入网络的设备分配IP地址. 因此同一个MAC地址的设备, 每次接入互联网中, 得到的IP地址不一定是相同的

2. NAT技术：NAT路由器，它至少有一个有效的外部全球IP地址（公网IP地址），所有使用本地地址（私网IP地址）的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和因特网连接。

3. IPv6: IPv6并不是IPv4的简单升级版. 这是互不相干的两个协议, 彼此并不兼容; IPv6用16字节128位来表示一个IP地址; 但是目前IPv6还没有普及



<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=10>
<a id="private_public_IP_address"></a>

<br/><br/>


#### 私有IP地址和公网IP地址


如果一个组织内部组建局域网,IP地址只用于局域网内的通信,而不直接连到Internet上,理论上 使用任意的IP地址都可以,但是RFC1918规定了用于组建局域网的私有IP地址：


- 10.0.0.0 - 10.255.255.255 (10/8比特前缀，前8位是网络号,共16,777,216个地址)

- 172.16.0.0 - 172.31.255.255 (172.16/12比特前缀，前12位是网络号,共1,048,576个地址)

- 192.168.0.0 - 192.168.255.255 (192.168/16比特前缀，前16位是网络号,共65,536个地址)

其余的则称为全局IP(或公网IP)

<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=10>
<a id="route"></a>

<br/><br/>


#### 路由

一个路由器可以配置两个IP地址, 一个是WAN口IP, 一个是LAN口IP(子网IP).

路由器LAN口连接的主机,都从属于当前这个路由器的子网中.不同的路由器,子网IP其实都是一样的(通常都是192.168.1.1)。子网内的主机IP地址不能重复. 但是子网之间的IP地址就可以重复了.

每一个家用路由器, 其实又作为运营商路由器的子网中的一个节点. 这样的运营商路由器可能会有很多级,最外层的运营商路由器, WAN口IP就是一个公网IP了.

子网内的主机需要和外网进行通信时, 路由器将IP首部中的IP地址进行替换(替换成WAN口IP), 这样逐级替换, 最终数据包中的IP地址成为一个公网IP. 这种技术称为NAT(Network Address Translation，网络地址转换).

如果希望我们自己实现的服务器程序, 能够在公网上被访问到, 就需要把程序部署在一台具有外网IP的服务器上. 这样的服务器可以在阿里云/腾讯云上进行购买.

##### 路由的过程

- 当IP数据包, 到达路由器时, 路由器会先查看目的IP;

- 路由器查看路由表，如果目的IP命中了路由表, 就直接转发即可;路由表中的最后一行,主要由下一跳地址和发送接口两部分组成,当目的地址与路由表中其它行都不匹配
时,就按缺省路由条目规定的接口发送到下一跳地址,即没命中需要发送给下一个路由器

- 依次反复, 一直到达目标IP地址;

##### 查看路由表信息

路由表可以使用route命令查看

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210418142420283.png)


这台主机有两个网络接口,一个网络接口连到192.168.10.0/24网络,另一个网络接口连到192.168.56.0/24网络;

路由表的Destination是目的网络地址,Genmask是子网掩码,Gateway是下一跳地址,Iface是发送接
口,Flags中的U标志表示此条目有效(可以禁用某些 条目),G标志表示此条目的下一跳地址是某个路由器的
地址,没有G标志的条目表示目的网络地址是与本机接口直接相连的网络,不必经路由器转发;


<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=10>
<a id="route_table_build"></a>

<br/><br/>


#### 路由表生成算法

路由表可以由网络管理员手动维护(静态路由), 也可以通过一些算法自动生成(动态路由)，例如距离向量算法, LS算法, Dijkstra算法等.

<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=50>




<a id="data_link_layer"></a>

<br/><br/>


## 数据链路层
<a id="Ethernet"></a>

<br/><br/>


### 以太网

"以太网" 不是一种具体的网络, 而是一种技术标准; 既包含了数据链路层的内容, 也包含了一些物理层的
内容. 例如: 规定了网络拓扑结构, 访问控制方式, 传输速率等;例如以太网中的网线必须使用双绞线; 传输速率有10M, 100M, 1000M等;

以太网是当前应用最广泛的局域网技术; 和以太网并列的还有令牌环网, 无线LAN等;
<a id="Ethernet_frame_form"></a>

<br/><br/>


#### 以太网帧格式(链路层)

![在这里插入图片描述](https://img-blog.csdnimg.cn/2021041814282130.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODA4NzAw,size_16,color_FFFFFF,t_70)

<a id="MAC"></a>

<br/><br/>


#### MAC地址

在网络1中以及提及请查看博文<a href="https://blog.csdn.net/qq_43808700/article/details/115834797?utm_source=app#mac">网络1-->mac</a>
<a id="MTU"></a>

<br/><br/>


#### MTU^[Maximum Transmission Unit]

MTU用来通知对方所能接受数据服务单元的最大尺寸，说明发送方能够接受的有效载荷大小。这个限制是**不同的数据链路对对应的物理层产生的限制**。

以太网帧中的数据长度规定最小46字节,最大1500字节,ARP数据包的长度不够46字节,要在后面补填充位;最大值1500称为以太网的最大传输单元(MTU),不同的**网络类型**有不同的MTU;不同的**数据链路层标准**的MTU是不同的;

如果一个数据包从以太网路由到拨号链路上,数据包长度大于拨号链路的MTU了,则需要对数据包进行分片(fragmentation);

##### MTU对IP协议的影响^[数据链路层的MTU对上层的影响]

由于数据链路层MTU的限制, 对于较大的IP数据包要进行分包

1. 将较大的IP包分成多个小包
2. 每个小包IP协议头的 16位标识(id) 都是相同的;
3. 每个小包的IP协议头的3位标志字段中, 第2位置为0, 表示允许分片, 第3位来表示结束标记(当前是否是最后一个小包, 是的话置为1, 否则置为0);
4. 到达对端时再将这些小包, 按顺序重组,拼装到一起返回给传输层;一旦这些小包中任意一个小包丢失,接收端的重组就会失败。但是IP层不会负责重新传输数据;

##### MTU对UDP协议的影响

一旦UDP携带的数据段超过1472(1500 - 20(IP首部) - 8(UDP首部)),那么就会在网络层分成多个IP数据报.这多个IP数据报有任意一个丢失,都会引起接收端网络层重组失败. 那么这就意味着, 如果UDP数据报在网络层被分片, **整个数据被丢失的概率就大大增加了**。

##### MTU对于TCP协议的影响

TCP的一个数据段也不能无限大, 还是受制于MTU. TCP的单个数据报的最大消息长度, 称为MSS(Max Segment Size);

TCP在建立连接的过程中, 通信双方会进行MSS协商。最理想的情况下,MSS的值正好是在IP(网络层)不会被分片处理的最大长度(这个长度仍然是受制于数据链路层的MTU)。


> 双方在发送SYN的时候会在TCP头部写入自己能支持的MSS值
>
> 然后双方得知对方的MSS值之后, 选择较小的作为最终MSS
>
> MSS的值就是在TCP首部的40字节变长选项中(kind=2)


    使用ifconfig命令, 即可查看ip地址, mac地址, 和MTU

##### 查看硬件地址和MTU

<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=30>









<a id="ARP"></a>

<br/><br/>


### ARP协议

ARP不是一个单纯的数据链路层的协议, 而是一个介于数据链路层和网络层之间的协议
<a id="ARP_application"></a>

<br/><br/>


#### ARP协议的作用

ARP协议建立了主机 IP地址 和 MAC地址 的映射关系

- 在网络通讯时,源主机的应用程序知道目的主机的IP地址和端口号,却不知道目的主机的硬件地址;

- 数据包首先是被网卡接收到再去处理上层协议的,如果接收到的数据包的硬件地址与本机不符,则直接丢弃;

- 因此在通讯前必须获得目的主机的硬件地址;


<a id="ARP_work_flow"></a>

<br/><br/>


#### ARP协议的工作流程

- 源主机发出ARP请求,询问“IP地址是192.168.0.1的主机的硬件地址是多少”, 并将这个请求广播到本地网段(以太网帧首部的硬件地址填FF:FF:FF:FF:FF:FF表示广播);

- 目的主机接收到广播的ARP请求,发现其中的IP地址与本机相符,则发送一个ARP应答数据包给源主机,将自己的硬件地址填写在应答包中;

- 每台主机都维护一个ARP缓存表,可以用arp -a命令查看。缓存表中的表项有过期时间(一般为20分钟),如果20分钟内没有再次使用某个表项,则该表项失效,下次还要发ARP请求来获得目的主机的硬件地址


<a id="ARP_message_form"></a>

<br/><br/>


#### ARP数据报的格式

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210418155153221.png)

注意到源MAC地址、目的MAC地址在以太网首部和ARP请求中各出现一次,对于链路层为以太网的情况是多余的,但如果链路层是其它类型的网络则有可能是必要的。

硬件类型指链路层网络类型,1为以太网;

协议类型指要转换的地址类型,0x0800为IP地址;

硬件地址长度对于以太网地址为6字节;

协议地址长度对于和IP地址为4字节;

op字段为1表示ARP请求,op字段为2表示ARP应答。




<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=50>







<a id="protocols"></a>

<br/><br/>


## 重要协议

<a id="DNS"></a>

<br/><br/>


### DNS^[Domain Name System]

DNS是一整套从域名映射到IP的系统

TCP/IP中使用IP地址和端口号来确定网络上的一台主机的一个程序. 但是IP地址不方便记忆

于是人们发明了一种叫主机名的东西, 是一个字符串, 并且使用hosts文件来描述主机名和IP地址的关系

> DNS是应用层协议
>
> DNS底层使用UDP进行解析
>
> 浏览器会缓存DNS结果

#### 浏览器中输入url后

1. 查找浏览器缓存

2. 先检查自己本地的hosts文件

3. 查找本地DNS解析器缓存

4. 路由器缓存

5. 找TCP/ip参数中设置的首选DNS服务器

6. 根DNS服务器

<img src="https://img-blog.csdnimg.cn/20210129183339102.png" height=30>



</font>